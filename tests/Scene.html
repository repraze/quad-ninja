<html>
	<head>
		<meta charset="UTF-8">
		<title>Test Scene</title>
		<script src="../Class.js"></script>
		<script src="../game.js"></script>
		<script src="../inputmanager.js"></script>
		<script src="../imagemanager.js"></script>
		<script src="../sprites.js"></script>
		<script src="../quadtree.js"></script>
		<script src="../entity.js"></script>
		<script src="../camera.js"></script>
		<script src="../scene.js"></script>
		<script src="../viewport.js"></script>
	</head>
	<body>
		<canvas id="gameCanvas" style="margin:auto;display:block; border : 10px solid black" width=1000 height=500></canvas>
		A scene with block represented as entities.<br>
		LEFT - RIGHT to move <br>
		UP - DOWN to zoom in/out <br>
		Character : <a href="http://cozah.deviantart.com/art/Human-Coza-Sprite-Sheet-279561640">Human Coza Sprite Sheet</a><br>

		<script>
		var	imgMgr = new ImageManager(function(){});
		var sprtMgr = new SpriteManager(imgMgr);

		var Hero= Entity.extend({
			init : function(){
				this._super({sprite:sprtMgr.getSprite("hero_idle")});
				this.dir=0; // (idle)
			},
			update : function(t){
				Entity.prototype.update.call(this,t);
				if((this.getPosition().x>=64*9 && this.dir===1 )|| (this.getPosition().x <0 && this.dir===-1)){
					this.idle();
				}
				else
					this.move({x:this.dir*256*t,y:0});
			},
			onKeyUp : function(key){
				if(key.keyCode === Key.LEFT)
					this.idle();
				if(key.keyCode === Key.RIGHT)
					this.idle();
			},
			idle : function(){
				this.dir = 0;
					//this.setSprite(sprtMgr.getSprite("hero_idle"));
					this.setSprite(sprtMgr.getSprite("hero_idle"));
		    },
			run : function(dir){
			  if(this.dir === dir)
				  return;
				this.dir = dir;
				if(dir==-1)
					this.setSprite(sprtMgr.getSprite("hero_running_left"));
				if(dir==1)
					this.setSprite(sprtMgr.getSprite("hero_running_right"));
			}
		});

		var Loading = GameState.extend({
			init : function(game){
				this._super(game);
				imgMgr.addListener(this);
				this.imgSrc = ["test1.png","sprite1.png","sprite2.png","sprite3.png","sprite4.png","sprite5.png"];
				this.imgCounter = this.imgSrc.length;
				this.imgSrc.forEach(function(src){imgMgr.load(src);});
			},
			update : function(t){
				if(this.imgCounter==0)
					this.game.changeState(new SimpleScene(this.game));
			},
			render : function(context){
				context.fillStyle = "#f00";
				context.fillRect(0,0,context.canvas.width,context.canvas.height);
				
			},
			onImageLoad : function(name,success){
				console.log(name+(success? " was" : " wasn't")+" loaded ");
				this.imgCounter--;
		  }
		});

		var SimpleScene = GameState.extend({
			init : function(game){
				this._super(game);
				sprtMgr.registerSprite({spriteName:"dirt",imageName:"sprite2.png",frames:1,speed:0});
				sprtMgr.registerSprite({spriteName:"hero_running_right",imageName:"sprite3.png",frames:8,speed:0.1});
				sprtMgr.registerSprite({spriteName:"hero_running_left",imageName:"sprite4.png",frames:8,speed:0.1});
				sprtMgr.registerSprite({spriteName:"hero_idle",imageName:"sprite5.png",frames:8,speed:0.2});
				this.scene = new Scene({width:64*10,height:500});
				this.camera = new Camera(this.scene,new Vector(60,60),{width:500,height:500/game.aspectRatio});
				this.viewport = new Viewport(this.game.canvas);
				this.viewport.setCamera(this.camera);
				for(var i =0; i< 10;i++){
					var ent = new Entity({sprite:sprtMgr.getSprite("dirt")});
					ent.setPosition({x:i*ent.getSprite().getWidth(),y:128});
					this.scene.addEntity(ent);
				}
				this.hero = new Hero();
				this.camera.follow(this.hero);
				this.camera.setAxis(Camera.Axis.BOTH);
				this.hero.move({x:0,y:64});
				this.scene.addEntity(this.hero);
				this.game.keyboard.addListener(this.hero);
			},
			render : function(context){
				context.clearRect(0,0,this.game.canvas.width,this.game.canvas.height);
				context.scale(this.game.canvas.width,this.game.canvas.height);
				context.fillStyle = "#dda";
				context.fillRect(0,0,0,1);
				this.viewport.render(context);
				context.scale(1/this.game.canvas.width,1/this.game.canvas.height);
			},
			update : function(t){
				if(this.game.keyboard.isKeyDown(Key.DOWN))
					this.camera.zoom(-5);
				if(this.game.keyboard.isKeyDown(Key.UP))
					this.camera.zoom(5);
				if(this.game.keyboard.isKeyDown(Key.LEFT))
					this.hero.run(-1);
				if(this.game.keyboard.isKeyDown(Key.RIGHT))
					this.hero.run(1);
				this.camera.update(t);
			}
			
		});

		var SceneTest =  Game.extend({
			init : function(){
				this._super(new Loading(this),document.getElementById("gameCanvas"));
				this.context.mozImageSmoothingEnabled = false;
			}
		});

		new SceneTest();
		</script>
	</body>
</html>
